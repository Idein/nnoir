version: 2.1

references:
  defaults: &defaults
    docker:
      - image: python:3.7-buster
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    environment:
      TZ: "/usr/share/zoneinfo/Asia/Tokyo"

commands:
  install-python-tools:
    steps:
      - run:
          name: Install python tools
          command: |
            pip3 install pytest autopep8
            pip3 install setuptools wheel twine
  test-nnoir:
    steps:
      - run:
          name: Check nnoir library code format
          working_directory: nnoir
          command: |
            [ $(autopep8 --diff --max-line-length 128 -r nnoir | wc -l) = 0 ]
      - run:
          name: Install nnoir library
          working_directory: nnoir
          command: |
            python3 setup.py install
      - run:
          name: Test nnoir library
          working_directory: nnoir
          command: |
            pytest -v
  test-nnoir-onnx:
    steps:
      - run:
          name: Check nnoir-onnx library code format
          working_directory: nnoir-onnx
          command: |
            [ $(autopep8 --diff --max-line-length 128 -r nnoir_onnx | wc -l) = 0 ]
      - run:
          name: Install nnoir-onnx library
          working_directory: nnoir-onnx
          command: |
            python3 setup.py install
      - run:
          name: Test nnoir-onnx
          working_directory: nnoir-onnx
          command: |
            pytest -v
      - run:
          name: Test nnoir-onnx example
          working_directory: nnoir-onnx
          command: |
            make -C example/mobilenetv2
            make -C example/super_resolution
  test-nnoir-chainer:
    steps:
      - run:
          name: Check nnoir-chainer library code format
          working_directory: nnoir-chainer
          command: |
            [ $(autopep8 --diff --max-line-length 128 -r nnoir_chainer | wc -l) = 0 ]
      - run:
          name: Install nnoir-chainer library
          working_directory: nnoir-chainer
          command: |
            pip3 install chainer
            python3 setup.py install
      - run:
          name: Test nnoir-chainer library
          working_directory: nnoir-chainer
          command: |
            pytest -v
      - run:
          name: Test nnoir-chainer example
          working_directory: nnoir-chainer
          command: |
            make -C example/mnist

jobs:
  test:
    <<: *defaults
    steps:
      - checkout
      - install-python-tools
      - test-nnoir
      - test-nnoir-onnx

  test-chainer-component:
    <<: *defaults
    steps:
      - checkout
      - install-python-tools
      - test-nnoir
      - test-nnoir-chainer

workflows:
  version: 2
  test:
    jobs:
      - test:
          context:
            - docker-hub-creds
      - test-chainer-component:
          context:
            - docker-hub-creds
  nightly:
    triggers:
      - schedule:
          cron: "0 16 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - test:
          context:
            - docker-hub-creds
      - test-chainer-component:
          context:
            - docker-hub-creds
