version: 2
references:
  defaults: &defaults
    docker:
      - image: python:buster
    environment:
      TZ: "/usr/share/zoneinfo/Asia/Tokyo"

jobs:
  test:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            pip3 install nose
            pip3 install numpy
            pip3 install chainer
            pip3 install autopep8
            pip3 install onnxruntime
      - run:
          name: Check nnoir library code format
          command: |
            cd nnoir
            [ $(autopep8 --diff --max-line-length 128 -r nnoir | wc -l) = 0 ]
      - run:
          name: Install nnoir library
          command: |
            cd nnoir
            python3 setup.py develop
      - run:
          name: Test nnoir library
          command: |
            cd nnoir
            nosetests -v test
      - run:
          name: Check nnoir-onnx library code format
          command: |
            cd nnoir-onnx
            [ $(autopep8 --diff --max-line-length 128 -r nnoir_onnx | wc -l) = 0 ]
      - run:
          name: Install nnoir-onnx library
          command: |
            cd nnoir-onnx
            python3 setup.py develop
      - run:
          name: Test nnoir-onnx example
          command: |
            make -C nnoir-onnx/example/mobilenetv2
      - run:
          name: Check nnoir-chainer library code format
          command: |
            cd nnoir-chainer
            [ $(autopep8 --diff --max-line-length 128 -r nnoir_chainer | wc -l) = 0 ]
      - run:
          name: Install nnoir-chainer library
          command: |
            cd nnoir-chainer
            python3 setup.py develop
      - run:
          name: Test nnoir-chainer library
          command: |
            cd nnoir-chainer
            nosetests -v test
      - run:
          name: Test nnoir-chainer example
          command: |
            make -C nnoir-chainer/example/mnist

workflows:
  version: 2
  test:
    jobs:
      - test
