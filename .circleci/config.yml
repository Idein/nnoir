version: 2.1

references:

  defaults: &defaults
    docker:
      - image: python:3.9-buster
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    environment:
      TZ: "/usr/share/zoneinfo/Asia/Tokyo"

commands:

  install-python-dev-tools:
    steps:
      - run:
          name: Install python dev tools and dependencies
          command: |
            apt-get update
            apt-get install -y --no-install-recommends python3-pip

  poetry-install:
    parameters:
      dir:
        type: string
    steps:
      - install-python-dev-tools
      - run:
          name: install poetry
          command: |
            curl -sSL https://install.python-poetry.org | python -
            echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
            poetry config virtualenvs.in-project true
      - run:
          name: poetry install in << parameters.dir >>
          working_directory: << parameters.dir >>
          command: |
            poetry install

  test-nnoir-chainer:
    steps:
      - run:
          name: Check nnoir-chainer library code format
          working_directory: nnoir-chainer
          command: |
            pysen run_files lint $(find -name "*.py")
      - run:
          name: Install nnoir-chainer library
          working_directory: nnoir-chainer
          command: |
            pip3 install chainer
            python3 setup.py install
      - run:
          name: Test nnoir-chainer library
          working_directory: nnoir-chainer
          command: |
            pytest -v
      - run:
          name: Test nnoir-chainer example
          working_directory: nnoir-chainer
          command: |
            make -C example/mnist

  test-blackonnx:
    steps:
      - run:
          name: Check blackonnx library code format
          working_directory: blackonnx
          command: |
            pysen run_files lint $(find -name "*.py")
      - run:
          name: Install blackonnx
          working_directory: blackonnx
          command: |
            python3 setup.py install
      - run:
          name: Test blackonnx example & test
          working_directory: blackonnx
          command: |
            pip3 install tflite2onnx
            make -C examples/models -j2
            make -C test -j2

  upload-package:
    parameters:
      library:
        description: target library
        type: string
      pypi-api-token:
        description: pypi API token
        type: string
    steps:
      - run:
          name: Check if git tag name is appropriate for package version
          working_directory: << parameters.library >>
          command: |
            export IMPORT_NAME=$(echo -n '<< parameters.library >>' | sed 's/-/_/g')
            export TAG=$(echo ${CIRCLE_TAG} |sed -e 's/<< parameters.library >>-//')
            export VERSION=$(python -c "import ${IMPORT_NAME}; print(${IMPORT_NAME}.__version__)")
            echo "Git tag: $TAG"
            echo "Package version: $VERSION"
            test "$VERSION" = "$TAG"
      - run:
          name: Packaging << parameters.library >>
          working_directory: << parameters.library >>
          command: |
            python3 setup.py sdist bdist_wheel
      - run:
          name: Publish wheel & sdist to PyPI
          working_directory: << parameters.library >>
          command: |
            pip3 install twine
            export TWINE_USERNAME=__token__
            export TWINE_PASSWORD=<< parameters.pypi-api-token >>
            python -m twine upload --non-interactive --repository pypi dist/*

jobs:

  build-test-release:
    <<: *defaults
    parameters:
      tests:
        description: test steps
        type: steps
        default: []
      releases:
        description: release steps
        type: steps
        default: []
    steps:
      - checkout
      - run:
          name: Install python test tools
          command: |
            pip3 install pytest pysen isort black==20.8b1
      - run:
          name: Install python release tools
          command: |
            pip3 install pytest pysen isort black==20.8b1
      - steps: << parameters.tests >>
      - steps: << parameters.releases >>

  check-nnoir:
    <<: *defaults
    steps:
      - checkout
      - poetry-install:
          dir: nnoir
      - run:
          name: Lint nnoir
          working_directory: nnoir
          command: |
            poetry run pysen run lint
      - run:
          name: Test nnoir
          working_directory: nnoir
          command: |
            poetry run pytest -v

  check-nnoir-onnx:
    <<: *defaults
    steps:
      - checkout
      - poetry-install:
          dir: nnoir-onnx
      - run:
          name: Lint nnoir-onnx
          working_directory: nnoir-onnx
          command: |
            poetry run pysen run lint
      - run:
          name: Test nnoir-onnx
          working_directory: nnoir-onnx
          command: |
            poetry run pytest -v
      - run:
          name: Test nnoir-onnx example
          working_directory: nnoir-onnx
          command: |
            poetry run make -C example/mobilenetv2
            poetry run make -C example/super_resolution

  validate-version-with-tag:
    <<: *defaults
    parameters:
      dir:
        type: string
      package-name:
        type: string
    steps:
      - checkout
      - poetry-install:
          dir: << parameters.dir >>
      - run:
          name: Check if git tag name is appropriate for package version
          working_directory: << parameters.dir >>
          command: |
            TAG=$(echo ${CIRCLE_TAG} |sed -e 's/<< parameters.package-name >>-//')
            VERSION=$(poetry run python -c 'import pkg_resources; print(pkg_resources.get_distribution("<< parameters.package-name >>").version)')
            echo "Git tag: $TAG"
            echo "Package version: $VERSION"
            test "$VERSION" = "$TAG"

  deploy-nnoir:
    <<: *defaults
    steps:
      - checkout
      - poetry-install:
          dir: nnoir
      - run:
          name: Publish wheel & sdist to PyPI
          working_directory: nnoir
          command: |
            poetry publish --build --username "__token__" --password "$PYPI_API_TOKEN_NNOIR" --no-interaction

  deploy-nnoir-onnx:
    <<: *defaults
    steps:
      - checkout
      - poetry-install:
          dir: nnoir-onnx
      - run:
          name: Publish wheel & sdist to PyPI
          working_directory: nnoir-onnx
          command: |
            poetry publish --build --username "__token__" --password "$PYPI_API_TOKEN_NNOIR_ONNX" --no-interaction


workflows:
  version: 2

  test:
    jobs: &test-only-workflow
      - build-test-release:
          name: blackonnx
          context:
            - docker-hub-creds
          tests:
            - test-blackonnx
      - build-test-release:
          name: test nnoir-chainer
          context:
            - docker-hub-creds
          tests:
            - test-nnoir-chainer
      - check-nnoir:
          context:
            - docker-hub-creds
      - check-nnoir-onnx:
          context:
            - docker-hub-creds

  nightly:
    triggers:
      - schedule:
          cron: "0 16 * * *"
          filters:
            branches:
              only:
                - master
    jobs: *test-only-workflow

  release-nnoir:
    jobs:
      - validate-version-with-tag:
          dir: nnoir
          package-name: nnoir
          context:
            - docker-hub-creds
          filters: &release-filter
            tags:
              only: /^nnoir-[0-9]+(\.[0-9]+){2}((a|b|rc)[0-9]+)?(.post[0-9])?(.dev[0-9])?$/
            branches:
              ignore: /.*/
      - deploy-nnoir:
          context:
            - docker-hub-creds
          requires:
            - validate-version-with-tag
          filters: *release-filter

  release-nnoir-onnx:
    jobs:
      - validate-version-with-tag:
          dir: nnoir-onnx
          package-name: nnoir-onnx
          context:
            - docker-hub-creds
          filters: &release-filter
            tags:
              only: /^nnoir-onnx-[0-9]+(\.[0-9]+){2}((a|b|rc)[0-9]+)?(.post[0-9])?(.dev[0-9])?$/
            branches:
              ignore: /.*/
      - deploy-nnoir-onnx:
          context:
            - docker-hub-creds
          requires:
            - validate-version-with-tag
          filters: *release-filter

  release-nnoir-chainer:
    jobs:
      - build-test-release:
          name: release nnoir-chainer
          context:
            - docker-hub-creds
          filters:
            tags:
              only: /^nnoir-chainer-[0-9]+(\.[0-9]+){2}((a|b|rc)[0-9]+)?(.post[0-9])?(.dev[0-9])?$/
            branches:
              ignore: /.*/
          tests:
            - test-nnoir
            - test-nnoir-chainer
          releases:
            - upload-package:
                library: nnoir-chainer
                pypi-api-token: $PYPI_API_TOKEN_NNOIR_CHAINER

  release-blackonnx:
    jobs:
      - build-test-release:
          name: release blackonnx
          context:
            - docker-hub-creds
          filters:
            tags:
              only: /^blackonnx-[0-9]+(\.[0-9]+){2}((a|b|rc)[0-9]+)?(.post[0-9])?(.dev[0-9])?$/
            branches:
              ignore: /.*/
          tests:
            - test-nnoir
            - test-nnoir-onnx
            - test-blackonnx
          releases:
            - upload-package:
                library: blackonnx
                pypi-api-token: $PYPI_API_TOKEN_BLACKONNX
